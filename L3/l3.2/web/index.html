<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Quick Shortener ‚Äî —Å–æ–∫—Ä–∞—â–∞–π —Å—Å—ã–ª–∫–∏</title>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #f8f8f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .wb-header {
            background: linear-gradient(90deg, #ff5e8b, #4a90e2);
            color: white;
            padding: 24px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 24px;
            letter-spacing: 0.5px;
        }

        .logo-icon {
            background: white;
            color: #8b57b5;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
        }

        .logo-text {
            text-transform: uppercase;
        }

        .logo-text span {
            font-weight: 300;
            opacity: 0.9;
        }

        .header-tagline {
            margin-left: auto;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 24px;
            flex: 1;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #222;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2:before {
            content: "‚Ä¢";
            color: #8b57b5;
            font-size: 28px;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #f0f0f0;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1 1 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #444;
        }

        input[type="text"],
        input[type="url"],
        input[type="search"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: 0.2s;
            background: #fafafa;
        }

        input:focus {
            outline: none;
            border-color: #8b57b5;
            background: white;
            box-shadow: 0 0 0 3px rgba(139, 87, 181, 0.1);
        }

        .note {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
        }

        .wb-button {
            background: #8b57b5;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .wb-button:hover {
            background: #7a49a3;
        }

        .wb-button:active {
            transform: scale(0.98);
        }

        .wb-button.secondary {
            background: white;
            color: #8b57b5;
            border: 1px solid #8b57b5;
            padding: 8px 16px;
            font-size: 14px;
        }

        .wb-button.secondary:hover {
            background: #f3edf9;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-left: 4px;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: #f0f0f0;
        }

        .table-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
            padding: 8px;
            border: 1px solid #f0f0f0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 16px;
            overflow: hidden;
        }

        th {
            text-align: left;
            padding: 16px 12px;
            background: #fafafa;
            color: #444;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 14px;
            color: #333;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #fafafa;
        }

        .short-url-cell {
            font-weight: 500;
            color: #8b57b5;
            word-break: break-all;
        }

        .original-url-cell {
            max-width: 200px;
            word-break: break-all;
            color: #666;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-section {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1 1 300px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: white;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #e0e0e0;
        }
        .search-box input {
            border: none;
            background: transparent;
            padding: 8px 0;
            flex: 1;
        }
        .search-box input:focus {
            box-shadow: none;
            border: none;
        }
        .search-box button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #8b57b5;
        }

        .result-area {
            margin-top: 16px;
            padding: 16px;
            background: #f0f0f0;
            border-radius: 16px;
            display: none;
        }
        .result-area.show {
            display: block;
        }
        .result-success {
            color: #1e7e34;
            font-weight: 500;
        }
        .result-error {
            color: #b02a37;
            font-weight: 500;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-header h3 {
            font-size: 24px;
            color: #222;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #888;
        }
        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #f8f8f8;
            border-radius: 16px;
            padding: 16px;
        }
        .stat-card .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #8b57b5;
        }
        .aggregation-buttons {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }
        .agg-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 500;
        }
        .agg-btn.active {
            background: #8b57b5;
            color: white;
        }
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .analytics-table th {
            background: #f0f0f0;
            padding: 12px;
        }
        .analytics-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }

        .wb-footer {
            background: white;
            border-top: 1px solid #eee;
            padding: 20px 24px;
            text-align: center;
            color: #777;
            font-size: 13px;
            margin-top: 40px;
        }

        .flex-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <header class="wb-header">
        <div class="logo">
            <div class="logo-icon">WB</div>
            <div class="logo-text">Quick<span>Shortener</span></div>
        </div>
        <div class="header-tagline">
            <span>üîó</span> –°–æ–∫—Ä–∞—â–∞–π —Å—Å—ã–ª–∫–∏ ¬∑ –°–æ–±–∏—Ä–∞–π –∞–Ω–∞–ª–∏—Ç–∏–∫—É
        </div>
    </header>

    <div class="container">
        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ -->
        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É</h2>
        <div class="form-card">
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>–î–ª–∏–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞</label>
                        <input type="url" id="originalUrl" placeholder="https://example.com/very/long/path" required>
                        <div class="note">üåê –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL, –≤–∫–ª—é—á–∞—è http:// –∏–ª–∏ https://</div>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="customShort" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, my-link">
                        <div class="note">üî§ –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ</div>
                    </div>
                </div>
                <div class="flex-row">
                    <button type="submit" class="wb-button">
                        <span>‚úÇÔ∏è</span> –°–æ–∫—Ä–∞—Ç–∏—Ç—å
                    </button>
                    <div id="creationResult" class="result-area"></div>
                </div>
            </form>
        </div>

        <!-- –ü–æ–∏—Å–∫: –¥–≤–∞ –ø–æ–ª—è -->
        <div class="search-section">
            <div class="search-box">
                <input type="search" id="searchOriginal" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ">
                <button id="searchOriginalBtn">üîç</button>
            </div>
            <div class="search-box">
                <input type="search" id="searchShort" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–µ">
                <button id="searchShortBtn">üîç</button>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ -->
        <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>
        <div class="table-wrapper">
            <table id="linksTable">
                <thead>
                    <tr>
                        <th>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</th>
                        <th>–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞</th>
                        <th>–ü–µ—Ä–µ—Ö–æ–¥—ã</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</th>
                    </tr>
                </thead>
                <tbody id="linksBody">
                    <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="analyticsShortUrlTitle">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ</h3>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            <div id="analyticsContent">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>

    <footer class="wb-footer">
        ‚í∏ WB Quick Shortener, 2026 ‚Äî –¥–µ–ª–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –∫–∞–∫ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ Wildberries
    </footer>

    <script>
        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        let links = [];          // –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        let filteredLinks = [];  // –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

        // –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏, —Ç–∞–∫ –∫–∞–∫ —Ñ—Ä–æ–Ω—Ç —Ä–∞–∑–¥–∞—ë—Ç—Å—è —Å —Ç–æ–≥–æ –∂–µ —Å–µ—Ä–≤–µ—Ä–∞)
        const API_BASE = '';

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLinks();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('createForm').addEventListener('submit', handleCreate);
            document.getElementById('searchOriginalBtn').addEventListener('click', () => searchLinks('original'));
            document.getElementById('searchShortBtn').addEventListener('click', () => searchLinks('short'));
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('analyticsModal').classList.remove('show');
            });
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('analyticsModal');
                if (e.target === modal) modal.classList.remove('show');
            });
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞ (GET /links) ---
        async function loadLinks() {
            try {
                const response = await fetch(`${API_BASE}/links`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                links = await response.json();
            } catch (e) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Å—ã–ª–∫–∏:', e);
                links = [];
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Å—ã–ª–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.', 'error');
            }
            filteredLinks = [...links];
            renderLinksTable(filteredLinks);
        }

        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã ---
        function renderLinksTable(linksArray) {
            const tbody = document.getElementById('linksBody');
            if (!linksArray || linksArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">üîó –°—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            linksArray.slice(0, 10).forEach(link => {
                const row = document.createElement('tr');
                const shortUrlFull = `${window.location.origin}/s/${link.short_url}`;
                row.innerHTML = `
                    <td class="original-url-cell" title="${link.original_url}">${truncate(link.original_url, 50)}</td>
                    <td class="short-url-cell">
                        <span title="${shortUrlFull}">${link.short_url}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${shortUrlFull}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É">üìã</button>
                    </td>
                    <td>${link.clicks_count || 0}</td>
                    <td>${formatDate(link.created_at)}</td>
                    <td class="actions">
                        <button class="refresh-btn" onclick="openAnalytics('${link.short_url}')">üìä</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏ (POST /shorten) ---
        async function handleCreate(e) {
            e.preventDefault();
            const originalUrl = document.getElementById('originalUrl').value.trim();
            const customShort = document.getElementById('customShort').value.trim();
            const resultDiv = document.getElementById('creationResult');
            resultDiv.classList.remove('show', 'result-success', 'result-error');

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!originalUrl) {
                showResult('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É', 'error');
                return;
            }
            try {
                new URL(originalUrl);
            } catch {
                showResult('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL. –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://', 'error');
                return;
            }
            if (customShort && !/^[a-zA-Z0-9_-]+$/.test(customShort)) {
                showResult('–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ', 'error');
                return;
            }

            const payload = { original_url: originalUrl };
            if (customShort) payload.custom_short = customShort;

            try {
                const response = await fetch(`${API_BASE}/shorten`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏';
                    if (errorMsg.toLowerCase().includes('–∑–∞–Ω—è—Ç–∞')) {
                        showResult('–¢–∞–∫–∞—è –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç', 'error');
                    } else {
                        showResult('–û—à–∏–±–∫–∞: ' + errorMsg, 'error');
                    }
                    return;
                }

                // –£—Å–ø–µ—Ö: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                links.unshift(data);
                filteredLinks = [...links];
                renderLinksTable(filteredLinks);
                showResult(`–°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: ${window.location.origin}/s/${data.short_url}`, 'success');
                document.getElementById('createForm').reset();
            } catch (error) {
                showResult('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                console.error(error);
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('creationResult');
            resultDiv.textContent = message;
            resultDiv.classList.add('show', type === 'success' ? 'result-success' : 'result-error');
            setTimeout(() => resultDiv.classList.remove('show'), 5000);
        }

        // --- –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ API ---
        async function searchLinks(type) {
            const query = type === 'original' 
                ? document.getElementById('searchOriginal').value.trim()
                : document.getElementById('searchShort').value.trim();

            if (!query) {
                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ)
                filteredLinks = [...links];
                renderLinksTable(filteredLinks);
                return;
            }

            const endpoint = type === 'original' ? '/links/search/original' : '/links/search/short';
            try {
                const response = await fetch(`${API_BASE}${endpoint}?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const results = await response.json();
                // results ‚Äî –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ Link (–∫–∞–∫ –∏ –≤ /links)
                filteredLinks = results;
                renderLinksTable(filteredLinks);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', e);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ', 'error');
            }
        }

        // --- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (GET /analytics/{short_url}) ---
        async function openAnalytics(shortUrl) {
            const modal = document.getElementById('analyticsModal');
            const contentDiv = document.getElementById('analyticsContent');
            document.getElementById('analyticsShortUrlTitle').textContent = `–ê–Ω–∞–ª–∏—Ç–∏–∫–∞: ${shortUrl}`;
            contentDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
            modal.classList.add('show');

            try {
                const response = await fetch(`${API_BASE}/analytics/${shortUrl}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                renderAnalytics(data, shortUrl);
            } catch (e) {
                contentDiv.innerHTML = `<p class="result-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É: ${e.message}</p>`;
            }
        }

        // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞) ---
        function renderAnalytics(data, shortUrl) {
            const link = data.link || {};
            // –ê–≥—Ä–µ–≥–∞—Ç—ã (–º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
            const clicksByDay = data.clicks_by_day || {};
            const clicksByMonth = data.clicks_by_month || {};
            const clicksByUserAgent = data.clicks_by_user_agent || {};
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã (–º–∞—Å—Å–∏–≤)
            const analytics = data.analytics || [];

            const contentDiv = document.getElementById('analyticsContent');

            let html = `
                <div class="analytics-stats">
                    <div class="stat-card"><span class="label">–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</span><div class="value">${link.clicks_count || 0}</div></div>
                    <div class="stat-card"><span class="label">–°–æ–∑–¥–∞–Ω–∞</span><div class="value">${formatDate(link.created_at)}</div></div>
                    <div class="stat-card"><span class="label">–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞</span><div class="value">${shortUrl}</div></div>
                </div>
                <h4>–ê–≥—Ä–µ–≥–∞—Ü–∏—è</h4>
                <div class="aggregation-buttons">
                    <button class="agg-btn active" id="aggDays">–ü–æ –¥–Ω—è–º</button>
                    <button class="agg-btn" id="aggMonths">–ü–æ –º–µ—Å—è—Ü–∞–º</button>
                    <button class="agg-btn" id="aggUA">–ü–æ User-Agent</button>
                </div>
                <div id="aggTableContainer"></div>
                <h4 style="margin-top:24px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</h4>
                <div id="recentClicksContainer"></div>
            `;
            contentDiv.innerHTML = html;

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
            function showAggregation(type) {
                let rows = '';
                let headerText = '–ö–ª—é—á';
                let dataMap = {};

                if (type === 'days') {
                    dataMap = clicksByDay;
                    headerText = '–î–∞—Ç–∞';
                } else if (type === 'months') {
                    dataMap = clicksByMonth;
                    headerText = '–ú–µ—Å—è—Ü';
                } else {
                    dataMap = clicksByUserAgent;
                    headerText = 'User-Agent';
                }

                for (const [key, value] of Object.entries(dataMap)) {
                    rows += `<tr><td>${key}</td><td>${value}</td></tr>`;
                }

                document.getElementById('aggTableContainer').innerHTML = `
                    <table class="analytics-table">
                        <thead><tr><th>${headerText}</th><th>–ü–µ—Ä–µ—Ö–æ–¥—ã</th></tr></thead>
                        <tbody>${rows || '<tr><td colspan="2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>'}</tbody>
                    </table>
                `;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã (–¥–æ 10)
            function renderRecentClicks() {
                const container = document.getElementById('recentClicksContainer');
                if (!analytics.length) {
                    container.innerHTML = '<p>–ù–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</p>';
                    return;
                }
                let tableHtml = `<table class="analytics-table"><thead><tr><th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th><th>User-Agent</th><th>IP</th><th>Referer</th></tr></thead><tbody>`;
                analytics.slice(0, 10).forEach(click => {
                    tableHtml += `<tr>
                        <td>${formatDate(click.accessed_at)}</td>
                        <td>${click.user_agent || '-'}</td>
                        <td>${click.ip_address || '-'}</td>
                        <td>${click.referer || '-'}</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;
            }

            showAggregation('days');
            renderRecentClicks();

            document.getElementById('aggDays').addEventListener('click', () => {
                document.querySelectorAll('.agg-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('aggDays').classList.add('active');
                showAggregation('days');
            });
            document.getElementById('aggMonths').addEventListener('click', () => {
                document.querySelectorAll('.agg-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('aggMonths').classList.add('active');
                showAggregation('months');
            });
            document.getElementById('aggUA').addEventListener('click', () => {
                document.querySelectorAll('.agg-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('aggUA').classList.add('active');
                showAggregation('ua');
            });
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        function truncate(str, max) {
            return str.length > max ? str.substring(0, max) + '‚Ä¶' : str;
        }

        function formatDate(value) {
            if (!value) return '-';
            const d = new Date(value);
            return isNaN(d.getTime()) ? '-' : d.toLocaleString();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + text);
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (—á–µ—Ä–µ–∑ fallback): ' + text);
            });
        }

        function showNotification(message, type) {
            alert(message); // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick
        window.openAnalytics = openAnalytics;
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>